<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diagram Editor</title>
<style>
/* ── CSS Reset & Variables ─────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #1e1e2e;
  --bg-secondary: #181825;
  --bg-tertiary: #313244;
  --bg-surface: #45475a;
  --text-primary: #cdd6f4;
  --text-secondary: #a6adc8;
  --text-muted: #6c7086;
  --accent: #89b4fa;
  --accent-hover: #74c7ec;
  --green: #a6e3a1;
  --red: #f38ba8;
  --yellow: #f9e2af;
  --border: #585b70;
  --divider: #45475a;
  --toast-bg: #313244;
  --scrollbar-thumb: #585b70;
  --scrollbar-track: #1e1e2e;
  --diff-add-bg: rgba(166,227,161,0.15);
  --diff-del-bg: rgba(243,139,168,0.15);
  --diff-add-border: rgba(166,227,161,0.4);
  --diff-del-border: rgba(243,139,168,0.4);
}

:root.light {
  --bg-primary: #eff1f5;
  --bg-secondary: #e6e9ef;
  --bg-tertiary: #ccd0da;
  --bg-surface: #bcc0cc;
  --text-primary: #4c4f69;
  --text-secondary: #5c5f77;
  --text-muted: #8c8fa1;
  --accent: #1e66f5;
  --accent-hover: #2a6ef5;
  --green: #40a02b;
  --red: #d20f39;
  --yellow: #df8e1d;
  --border: #9ca0b0;
  --divider: #bcc0cc;
  --toast-bg: #ccd0da;
  --scrollbar-thumb: #9ca0b0;
  --scrollbar-track: #eff1f5;
  --diff-add-bg: rgba(64,160,43,0.12);
  --diff-del-bg: rgba(210,15,57,0.12);
  --diff-add-border: rgba(64,160,43,0.35);
  --diff-del-border: rgba(210,15,57,0.35);
}

html, body {
  height: 100%;
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }

/* ── App Layout ────────────────────────────────────────────────────── */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* ── Toolbar ───────────────────────────────────────────────────────── */
#toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  flex-wrap: wrap;
}

#toolbar .separator {
  width: 1px;
  height: 24px;
  background: var(--border);
  margin: 0 4px;
}

.tb-group { display: flex; align-items: center; gap: 4px; }

.tb-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 5px 10px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.15s, border-color 0.15s;
  white-space: nowrap;
}
.tb-btn:hover { background: var(--bg-surface); border-color: var(--accent); }
.tb-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.tb-btn:disabled:hover { background: var(--bg-tertiary); border-color: var(--border); }
.tb-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }

.tb-btn svg { width: 16px; height: 16px; flex-shrink: 0; }

#history-indicator {
  font-size: 12px;
  color: var(--text-muted);
  min-width: 80px;
  text-align: center;
}

#format-badge {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 10px;
  background: var(--accent);
  color: var(--bg-primary);
  font-weight: 600;
  text-transform: uppercase;
}

.tb-spacer { flex: 1; }

/* ── Main Content Area ─────────────────────────────────────────────── */
#main-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

#panes-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ── Panes ─────────────────────────────────────────────────────────── */
.pane {
  display: flex;
  flex-direction: column;
  min-width: 200px;
  overflow: hidden;
}

#left-pane { flex: 1; }
#right-pane { flex: 1; }

.pane-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.pane-header .badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 8px;
  background: var(--bg-surface);
  color: var(--text-muted);
  font-weight: 400;
}

.pane-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Render area */
.render-area {
  flex: 1;
  overflow: auto;
  padding: 16px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  background: var(--bg-primary);
  position: relative;
}

.render-area svg { max-width: 100%; height: auto; }

.render-error {
  color: var(--red);
  font-size: 13px;
  padding: 12px;
  background: var(--diff-del-bg);
  border: 1px solid var(--diff-del-border);
  border-radius: 6px;
  white-space: pre-wrap;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  max-width: 100%;
  overflow: auto;
}

/* Source collapse */
.source-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  cursor: pointer;
  font-size: 12px;
  color: var(--text-muted);
  user-select: none;
  flex-shrink: 0;
}
.source-toggle:hover { color: var(--text-secondary); }
.source-toggle .arrow { transition: transform 0.2s; }
.source-toggle .arrow.open { transform: rotate(90deg); }

.source-area {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: var(--bg-secondary);
  flex-shrink: 0;
}
.source-area.open { max-height: 300px; overflow: auto; }

.source-area pre {
  padding: 12px;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  font-size: 12px;
  line-height: 1.5;
  color: var(--text-primary);
  white-space: pre-wrap;
  word-break: break-word;
}

/* Editor area (right pane) */
.editor-area {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  position: relative;
}
.editor-area.open { max-height: 300px; overflow: hidden; }

#source-editor {
  width: 100%;
  height: 250px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: none;
  padding: 12px;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  font-size: 12px;
  line-height: 1.5;
  resize: none;
  outline: none;
  tab-size: 2;
}

/* Parse error display */
#parse-error {
  display: none;
  padding: 8px 12px;
  background: var(--diff-del-bg);
  border-top: 1px solid var(--diff-del-border);
  color: var(--red);
  font-size: 12px;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
}

/* ── Divider (draggable) ───────────────────────────────────────────── */
#pane-divider {
  width: 5px;
  cursor: col-resize;
  background: var(--divider);
  flex-shrink: 0;
  transition: background 0.15s;
}
#pane-divider:hover, #pane-divider.dragging { background: var(--accent); }

/* ── Diff View ─────────────────────────────────────────────────────── */
.diff-container {
  flex: 1;
  overflow: auto;
  padding: 0;
  background: var(--bg-primary);
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  font-size: 12px;
  line-height: 1.6;
}

.diff-line {
  padding: 1px 12px;
  white-space: pre-wrap;
  word-break: break-word;
}
.diff-line.added {
  background: var(--diff-add-bg);
  border-left: 3px solid var(--diff-add-border);
}
.diff-line.removed {
  background: var(--diff-del-bg);
  border-left: 3px solid var(--diff-del-border);
}
.diff-line.unchanged {
  color: var(--text-muted);
  border-left: 3px solid transparent;
}

.diff-actions {
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.diff-btn {
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: opacity 0.15s;
}
.diff-btn:hover { opacity: 0.85; }
.diff-btn.accept { background: var(--green); color: #1e1e2e; }
.diff-btn.reject { background: var(--red); color: #1e1e2e; }
.diff-btn.edit { background: var(--yellow); color: #1e1e2e; }

/* ── Chat Panel ────────────────────────────────────────────────────── */
#chat-panel {
  display: flex;
  flex-direction: column;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  flex-shrink: 0;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s ease;
}
#chat-panel.open { max-height: 350px; }

#chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  cursor: pointer;
  user-select: none;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

#chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 80px;
}

.chat-msg {
  max-width: 85%;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 13px;
  line-height: 1.4;
  word-break: break-word;
}
.chat-msg.user {
  align-self: flex-end;
  background: var(--accent);
  color: var(--bg-primary);
  border-bottom-right-radius: 3px;
}
.chat-msg.assistant {
  align-self: flex-start;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-bottom-left-radius: 3px;
}
.chat-msg.error {
  align-self: flex-start;
  background: var(--diff-del-bg);
  color: var(--red);
  border: 1px solid var(--diff-del-border);
}

#chat-input-row {
  display: flex;
  gap: 8px;
  padding: 8px 12px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

#chat-input {
  flex: 1;
  padding: 8px 12px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  outline: none;
  font-family: inherit;
}
#chat-input:focus { border-color: var(--accent); }
#chat-input::placeholder { color: var(--text-muted); }

#chat-send {
  padding: 8px 16px;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}
#chat-send:hover { background: var(--accent-hover); }
#chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

/* ── Empty State ───────────────────────────────────────────────────── */
#empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  padding: 40px;
  text-align: center;
}

#empty-state h2 {
  font-size: 22px;
  margin-bottom: 8px;
  color: var(--text-primary);
}
#empty-state p {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 24px;
  max-width: 500px;
}

#drop-zone {
  width: 100%;
  max-width: 600px;
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 32px;
  transition: border-color 0.2s, background 0.2s;
  cursor: pointer;
}
#drop-zone.dragover {
  border-color: var(--accent);
  background: rgba(137,180,250,0.06);
}

#drop-zone textarea {
  width: 100%;
  min-height: 150px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  font-size: 12px;
  line-height: 1.5;
  resize: vertical;
  outline: none;
  margin-bottom: 12px;
}
#drop-zone textarea:focus { border-color: var(--accent); }
#drop-zone textarea::placeholder { color: var(--text-muted); }

#load-btn {
  padding: 10px 28px;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}
#load-btn:hover { background: var(--accent-hover); }

.example-formats {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  flex-wrap: wrap;
  justify-content: center;
}

.example-chip {
  padding: 5px 12px;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  cursor: pointer;
  transition: border-color 0.15s;
}
.example-chip:hover { border-color: var(--accent); color: var(--accent); }

/* ── Toasts ────────────────────────────────────────────────────────── */
#toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 9999;
  pointer-events: none;
}

.toast {
  padding: 10px 18px;
  background: var(--toast-bg);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  animation: toast-in 0.25s ease, toast-out 0.25s ease 2.5s forwards;
  pointer-events: auto;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--accent); }

@keyframes toast-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toast-out { from { opacity: 1; } to { opacity: 0; } }

/* ── Spinner ───────────────────────────────────────────────────────── */
.spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 2px solid var(--text-muted);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── API Key Modal ─────────────────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 450px;
  width: 90%;
}
.modal h3 { margin-bottom: 12px; font-size: 16px; }
.modal p { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
.modal input {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  outline: none;
  margin-bottom: 16px;
}
.modal input:focus { border-color: var(--accent); }
.modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
.modal-btns button {
  padding: 8px 18px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}
.modal-btns .primary { background: var(--accent); color: var(--bg-primary); }
.modal-btns .secondary { background: var(--bg-tertiary); color: var(--text-primary); }

/* ── Context menu ──────────────────────────────────────────────────── */
#context-menu {
  position: fixed;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 0;
  min-width: 180px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  z-index: 9998;
  display: none;
}
#context-menu .ctx-item {
  padding: 8px 16px;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-primary);
}
#context-menu .ctx-item:hover { background: var(--bg-tertiary); }
#context-menu .ctx-sep {
  height: 1px;
  background: var(--border);
  margin: 4px 0;
}

/* ── Property Panel (node editing) ─────────────────────────────────── */
#property-panel {
  display: none;
  position: fixed;
  right: 20px;
  top: 80px;
  width: 260px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  z-index: 5000;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}
#property-panel h4 {
  font-size: 14px;
  margin-bottom: 12px;
  color: var(--text-secondary);
}
#property-panel label {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 4px;
  margin-top: 10px;
}
#property-panel input, #property-panel select {
  width: 100%;
  padding: 6px 10px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
  outline: none;
}
#property-panel input:focus, #property-panel select:focus { border-color: var(--accent); }
#prop-apply {
  margin-top: 14px;
  width: 100%;
  padding: 7px;
  background: var(--accent);
  color: var(--bg-primary);
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
#prop-close {
  position: absolute;
  top: 8px;
  right: 10px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
}

/* ── Zoom ──────────────────────────────────────────────────────────── */
.render-area .zoom-wrapper {
  transform-origin: center top;
  transition: transform 0.15s ease;
}

/* ── Hidden ────────────────────────────────────────────────────────── */
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="app">
  <!-- Toolbar -->
  <div id="toolbar">
    <div class="tb-group">
      <button class="tb-btn" id="btn-undo" title="Undo (Ctrl+Z)" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h13a4 4 0 010 8H7"/><path d="M3 10l4-4M3 10l4 4"/></svg>
        Undo
      </button>
      <button class="tb-btn" id="btn-redo" title="Redo (Ctrl+Shift+Z)" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10H8a4 4 0 000 8h9"/><path d="M21 10l-4-4M21 10l-4 4"/></svg>
        Redo
      </button>
      <span id="history-indicator"></span>
    </div>

    <div class="separator"></div>

    <div class="tb-group">
      <button class="tb-btn" id="btn-zoom-in" title="Zoom In">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6M11 8v6"/></svg>
      </button>
      <button class="tb-btn" id="btn-zoom-out" title="Zoom Out">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/></svg>
      </button>
      <button class="tb-btn" id="btn-zoom-reset" title="Reset Zoom">1:1</button>
    </div>

    <div class="separator"></div>

    <div class="tb-group">
      <span id="format-badge" class="hidden">---</span>
    </div>

    <div class="tb-spacer"></div>

    <div class="tb-group">
      <button class="tb-btn" id="btn-chat-toggle" title="Toggle Chat Panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Chat
      </button>
      <button class="tb-btn" id="btn-theme" title="Toggle Theme">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
      <button class="tb-btn" id="btn-export" title="Export Diagram">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Export
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state">
    <h2>Diagram Editor</h2>
    <p>Paste a diagram below or drag and drop a file to get started. Supports Mermaid, PlantUML, and Graphviz DOT formats.</p>
    <div id="drop-zone">
      <textarea id="input-source" placeholder="Paste your diagram source here...&#10;&#10;Example Mermaid:&#10;graph TD&#10;  A[Start] --> B{Decision}&#10;  B -->|Yes| C[Do something]&#10;  B -->|No| D[Do something else]&#10;  C --> E[End]&#10;  D --> E"></textarea>
      <button id="load-btn">Load Diagram</button>
      <input type="file" id="file-input" accept=".mmd,.puml,.dot,.gv,.mermaid,.plantuml,.txt" style="display:none">
      <div class="example-formats">
        <span class="example-chip" data-example="mermaid">Mermaid Example</span>
        <span class="example-chip" data-example="plantuml">PlantUML Example</span>
        <span class="example-chip" data-example="graphviz">Graphviz Example</span>
      </div>
    </div>
  </div>

  <!-- Editor View (hidden initially) -->
  <div id="editor-view" class="hidden">
    <div id="panes-container">
      <!-- Left Pane: Original -->
      <div class="pane" id="left-pane">
        <div class="pane-header">
          Original
          <span class="badge">read-only</span>
        </div>
        <div class="pane-body">
          <div class="render-area" id="left-render">
            <div class="zoom-wrapper" id="left-zoom-wrapper"></div>
          </div>
          <div class="source-toggle" id="left-source-toggle">
            <span class="arrow">&#9654;</span> Source
          </div>
          <div class="source-area" id="left-source-area">
            <pre id="left-source-text"></pre>
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div id="pane-divider"></div>

      <!-- Right Pane: Working Copy -->
      <div class="pane" id="right-pane">
        <div class="pane-header">
          Working Copy
          <span class="badge" id="right-badge">editable</span>
        </div>
        <div class="pane-body">
          <div class="render-area" id="right-render">
            <div class="zoom-wrapper" id="right-zoom-wrapper"></div>
          </div>
          <!-- Diff view (shown when AI proposes changes) -->
          <div class="diff-container hidden" id="diff-container"></div>
          <div class="diff-actions hidden" id="diff-actions">
            <button class="diff-btn accept" id="btn-diff-accept">&#10004; Accept</button>
            <button class="diff-btn reject" id="btn-diff-reject">&#10008; Reject</button>
            <button class="diff-btn edit" id="btn-diff-edit">&#9998; Edit</button>
          </div>
          <div class="source-toggle" id="right-source-toggle">
            <span class="arrow">&#9654;</span> Editor
          </div>
          <div class="editor-area" id="right-editor-area">
            <textarea id="source-editor" spellcheck="false"></textarea>
            <div id="parse-error"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel">
      <div id="chat-header">
        <span>AI Chat</span>
        <span style="font-size:12px; color:var(--text-muted)">Natural language diagram editing</span>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input-row">
        <input type="text" id="chat-input" placeholder="Describe changes to the diagram..." />
        <button id="chat-send">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="context-menu">
  <div class="ctx-item" data-action="add-node">&#43; Add Node</div>
  <div class="ctx-item" data-action="add-edge">&#8594; Add Edge</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="group">&#9633; Group into Subgraph</div>
  <div class="ctx-item" data-action="collapse">&#9660; Collapse/Mask</div>
  <div class="ctx-item" data-action="expand">&#9650; Expand</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="delete" style="color:var(--red)">&#10005; Delete</div>
</div>

<!-- Property Panel -->
<div id="property-panel">
  <button id="prop-close">&times;</button>
  <h4>Node Properties</h4>
  <label>Label</label>
  <input type="text" id="prop-label" />
  <label>Shape</label>
  <select id="prop-shape">
    <option value="default">Default</option>
    <option value="round">Rounded</option>
    <option value="stadium">Stadium</option>
    <option value="diamond">Diamond</option>
    <option value="hexagon">Hexagon</option>
    <option value="cylinder">Cylinder</option>
  </select>
  <label>Style (CSS)</label>
  <input type="text" id="prop-style" placeholder="fill:#f96,stroke:#333" />
  <button id="prop-apply">Apply Changes</button>
</div>

<!-- Export Modal -->
<div class="modal-overlay hidden" id="export-modal">
  <div class="modal">
    <h3>Export Diagram</h3>
    <p>Choose an export option for your diagram.</p>
    <div class="modal-btns" style="flex-direction:column;gap:8px">
      <button class="primary" id="export-clipboard" style="width:100%">Copy Source to Clipboard</button>
      <button class="primary" id="export-file" style="width:100%">Download Source File</button>
      <button class="primary" id="export-svg" style="width:100%">Download as SVG</button>
      <button class="primary" id="export-png" style="width:100%">Download as PNG</button>
      <button class="secondary" id="export-cancel" style="width:100%">Cancel</button>
    </div>
  </div>
</div>

<!-- API Key Modal -->
<div class="modal-overlay hidden" id="apikey-modal">
  <div class="modal">
    <h3>Gemini API Key</h3>
    <p>Enter your Google Gemini API key to enable AI chat editing. The key is stored locally in your browser.</p>
    <input type="password" id="apikey-input" placeholder="AIza..." />
    <div class="modal-btns">
      <button class="secondary" id="apikey-cancel">Cancel</button>
      <button class="primary" id="apikey-save">Save</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- External deps -->
<script type="module">
// ── Mermaid ────────────────────────────────────────────────────────
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

mermaid.initialize({
  startOnLoad: false,
  theme: 'dark',
  securityLevel: 'loose',
  flowchart: { htmlLabels: true, curve: 'basis' },
});

// ── Graphviz (hpcc-js/wasm) ────────────────────────────────────────
let graphvizInstance = null;
async function getGraphviz() {
  if (graphvizInstance) return graphvizInstance;
  try {
    const mod = await import('https://cdn.jsdelivr.net/npm/@hpcc-js/wasm-graphviz@1/dist/index.js');
    graphvizInstance = await mod.Graphviz.load();
    return graphvizInstance;
  } catch (e) {
    console.error('Failed to load Graphviz WASM:', e);
    return null;
  }
}

// ── State ──────────────────────────────────────────────────────────
const state = {
  originalSource: '',
  workingSource: '',
  format: null,             // 'mermaid' | 'plantuml' | 'graphviz'
  historyStack: [],
  historyIndex: -1,
  pendingProposal: null,    // { source: string } when AI proposes changes
  preProposalSource: null,
  collapsedNodes: new Map(), // nodeId -> { original subgraph source, label }
  zoom: 1,
  geminiApiKey: localStorage.getItem('gemini_api_key') || '',
};

let mermaidIdCounter = 0;
let editorDebounceTimer = null;

// ── Helpers ────────────────────────────────────────────────────────
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  $('#toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ── Format Detection ───────────────────────────────────────────────
function detectFormat(source) {
  const trimmed = source.trim();
  // Mermaid patterns
  if (/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|gantt|pie|gitGraph|journey|mindmap|timeline|sankey|quadrantChart|xychart|block-beta)\b/im.test(trimmed)) {
    return 'mermaid';
  }
  if (/^---\s*\n/.test(trimmed) && /^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram)/im.test(trimmed)) {
    return 'mermaid';
  }
  // PlantUML
  if (/^@start(uml|mindmap|salt|wbs|ditaa|gantt|json|yaml)/im.test(trimmed)) {
    return 'plantuml';
  }
  // Graphviz DOT
  if (/^(strict\s+)?(di)?graph\s+/im.test(trimmed) || /^(strict\s+)?(di)?graph\s*\{/im.test(trimmed)) {
    return 'graphviz';
  }
  return null;
}

// ── Rendering ──────────────────────────────────────────────────────
async function renderMermaid(source, container) {
  try {
    const id = `mermaid-svg-${++mermaidIdCounter}`;
    const { svg } = await mermaid.render(id, source);
    container.innerHTML = svg;
    return { ok: true };
  } catch (e) {
    return { ok: false, error: e.message || String(e) };
  }
}

async function renderPlantUML(source, container) {
  try {
    const encoded = plantumlEncode(source);
    const url = `https://www.plantuml.com/plantuml/svg/${encoded}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`PlantUML server returned ${resp.status}`);
    const svg = await resp.text();
    if (svg.includes('<svg')) {
      container.innerHTML = svg;
      return { ok: true };
    }
    throw new Error('Invalid SVG from PlantUML server');
  } catch (e) {
    return { ok: false, error: e.message || String(e) };
  }
}

// PlantUML text encoding (deflate + base64 variant)
function plantumlEncode(text) {
  // Use the simple hex encoding approach via plantuml server ~h prefix
  const hex = Array.from(new TextEncoder().encode(text))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
  return '~h' + hex;
}

async function renderGraphviz(source, container) {
  try {
    const gv = await getGraphviz();
    if (!gv) throw new Error('Graphviz WASM not loaded');
    const svg = gv.dot(source);
    container.innerHTML = svg;
    return { ok: true };
  } catch (e) {
    return { ok: false, error: e.message || String(e) };
  }
}

async function renderDiagram(source, container, format) {
  // Clear previous
  const wrapper = container.querySelector('.zoom-wrapper');
  const target = wrapper || container;

  if (!source.trim()) {
    target.innerHTML = '<span style="color:var(--text-muted)">No diagram source</span>';
    return { ok: true };
  }

  switch (format) {
    case 'mermaid': return renderMermaid(source, target);
    case 'plantuml': return renderPlantUML(source, target);
    case 'graphviz': return renderGraphviz(source, target);
    default:
      target.innerHTML = `<span class="render-error">Unknown format</span>`;
      return { ok: false, error: 'Unknown format' };
  }
}

function showRenderError(container, error) {
  const wrapper = container.querySelector('.zoom-wrapper') || container;
  wrapper.innerHTML = `<div class="render-error">Render error:\n${error}</div>`;
}

// ── History ────────────────────────────────────────────────────────
function pushHistory(source) {
  // Discard forward history
  state.historyStack = state.historyStack.slice(0, state.historyIndex + 1);
  state.historyStack.push(source);
  state.historyIndex = state.historyStack.length - 1;
  updateHistoryUI();
}

function undo() {
  if (state.historyIndex <= 0) return;
  state.historyIndex--;
  const source = state.historyStack[state.historyIndex];
  state.workingSource = source;
  applyWorkingSource(false);
  updateHistoryUI();
  toast('Undone', 'info');
}

function redo() {
  if (state.historyIndex >= state.historyStack.length - 1) return;
  state.historyIndex++;
  const source = state.historyStack[state.historyIndex];
  state.workingSource = source;
  applyWorkingSource(false);
  updateHistoryUI();
  toast('Redone', 'info');
}

function updateHistoryUI() {
  $('#btn-undo').disabled = state.historyIndex <= 0;
  $('#btn-redo').disabled = state.historyIndex >= state.historyStack.length - 1;
  if (state.historyStack.length > 1) {
    $('#history-indicator').textContent = `Step ${state.historyIndex + 1} of ${state.historyStack.length}`;
  } else {
    $('#history-indicator').textContent = '';
  }
}

// ── Apply working source to right pane ─────────────────────────────
async function applyWorkingSource(addToHistory = true) {
  const source = state.workingSource;
  if (addToHistory) pushHistory(source);

  // Update editor
  $('#source-editor').value = source;

  // Render right pane
  const result = await renderDiagram(source, $('#right-render'), state.format);
  if (!result.ok) {
    showRenderError($('#right-render'), result.error);
    $('#parse-error').style.display = 'block';
    $('#parse-error').textContent = result.error;
  } else {
    $('#parse-error').style.display = 'none';
  }

  applyZoom();
}

// ── Load diagram ───────────────────────────────────────────────────
async function loadDiagram(source) {
  const format = detectFormat(source);
  if (!format) {
    toast('Could not detect diagram format. Supported: Mermaid, PlantUML, Graphviz DOT.', 'error');
    return;
  }

  state.originalSource = source;
  state.workingSource = source;
  state.format = format;
  state.historyStack = [source];
  state.historyIndex = 0;
  state.pendingProposal = null;
  state.preProposalSource = null;
  state.collapsedNodes.clear();
  state.zoom = 1;

  // Update UI
  $('#empty-state').classList.add('hidden');
  $('#editor-view').classList.remove('hidden');
  $('#format-badge').classList.remove('hidden');
  $('#format-badge').textContent = format;
  $('#left-source-text').textContent = source;

  // Update mermaid theme based on current theme
  const isDark = !document.documentElement.classList.contains('light');
  mermaid.initialize({
    startOnLoad: false,
    theme: isDark ? 'dark' : 'default',
    securityLevel: 'loose',
    flowchart: { htmlLabels: true, curve: 'basis' },
  });

  // Render both panes
  const leftResult = await renderDiagram(source, $('#left-render'), format);
  if (!leftResult.ok) showRenderError($('#left-render'), leftResult.error);

  await applyWorkingSource(false);
  updateHistoryUI();
  toast(`Loaded ${format} diagram`, 'success');
}

// ── Diff computation ───────────────────────────────────────────────
function computeDiff(oldText, newText) {
  const oldLines = oldText.split('\n');
  const newLines = newText.split('\n');
  const result = [];

  // Simple LCS-based diff
  const m = oldLines.length, n = newLines.length;
  // Build LCS table
  const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      if (oldLines[i - 1] === newLines[j - 1]) {
        dp[i][j] = dp[i - 1][j - 1] + 1;
      } else {
        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
      }
    }
  }

  // Backtrack
  let i = m, j = n;
  const ops = [];
  while (i > 0 && j > 0) {
    if (oldLines[i - 1] === newLines[j - 1]) {
      ops.push({ type: 'unchanged', text: oldLines[i - 1] });
      i--; j--;
    } else if (dp[i - 1][j] >= dp[i][j - 1]) {
      ops.push({ type: 'removed', text: oldLines[i - 1] });
      i--;
    } else {
      ops.push({ type: 'added', text: newLines[j - 1] });
      j--;
    }
  }
  while (i > 0) { ops.push({ type: 'removed', text: oldLines[--i] }); }
  while (j > 0) { ops.push({ type: 'added', text: newLines[--j] }); }

  return ops.reverse();
}

function showDiff(oldSource, newSource) {
  const diff = computeDiff(oldSource, newSource);
  const container = $('#diff-container');
  container.innerHTML = '';
  for (const op of diff) {
    const line = document.createElement('div');
    line.className = `diff-line ${op.type}`;
    const prefix = op.type === 'added' ? '+ ' : op.type === 'removed' ? '- ' : '  ';
    line.textContent = prefix + op.text;
    container.appendChild(line);
  }
  container.classList.remove('hidden');
  $('#diff-actions').classList.remove('hidden');
  // Hide the render and editor in right pane during diff
  $('#right-render').classList.add('hidden');
  $('#right-source-toggle').classList.add('hidden');
  $('#right-editor-area').classList.remove('open');
}

function hideDiff() {
  $('#diff-container').classList.add('hidden');
  $('#diff-actions').classList.add('hidden');
  $('#right-render').classList.remove('hidden');
  $('#right-source-toggle').classList.remove('hidden');
}

// ── Gemini AI Chat ─────────────────────────────────────────────────
function getApiKey() {
  return state.geminiApiKey || localStorage.getItem('gemini_api_key') || '';
}

function showApiKeyModal() {
  return new Promise((resolve) => {
    $('#apikey-modal').classList.remove('hidden');
    $('#apikey-input').value = getApiKey();
    $('#apikey-input').focus();

    const save = () => {
      const key = $('#apikey-input').value.trim();
      if (key) {
        state.geminiApiKey = key;
        localStorage.setItem('gemini_api_key', key);
      }
      $('#apikey-modal').classList.add('hidden');
      resolve(key);
    };
    const cancel = () => {
      $('#apikey-modal').classList.add('hidden');
      resolve(null);
    };

    $('#apikey-save').onclick = save;
    $('#apikey-cancel').onclick = cancel;
    $('#apikey-input').onkeydown = (e) => { if (e.key === 'Enter') save(); };
  });
}

async function callGemini(userRequest) {
  let apiKey = getApiKey();
  if (!apiKey) {
    apiKey = await showApiKeyModal();
    if (!apiKey) {
      toast('API key required for AI chat', 'error');
      return null;
    }
  }

  const systemPrompt = `You are a diagram editing assistant. You modify diagram source code based on user requests.

RULES:
- Output ONLY the complete updated diagram source code, nothing else
- No explanations, no markdown code fences, no comments about changes
- Preserve all unchanged elements exactly as they are
- The diagram format is: ${state.format}
- Output must be valid ${state.format} syntax
- Return the COMPLETE diagram, not a partial patch`;

  const userPrompt = `Current diagram source (${state.format} format):
\`\`\`
${state.workingSource}
\`\`\`

User request: ${userRequest}

Output ONLY the updated diagram source:`;

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
        generationConfig: {
          temperature: 0.3,
          maxOutputTokens: 8192,
        }
      })
    });

    if (!resp.ok) {
      const errBody = await resp.text();
      throw new Error(`Gemini API error ${resp.status}: ${errBody}`);
    }

    const data = await resp.json();
    let text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

    // Strip markdown code fences if present
    text = text.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '').trim();

    return text;
  } catch (e) {
    // Retry once
    try {
      const resp2 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system_instruction: { parts: [{ text: systemPrompt }] },
          contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 8192 }
        })
      });
      if (!resp2.ok) throw new Error('Retry failed');
      const data2 = await resp2.json();
      let text = data2?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      text = text.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '').trim();
      return text;
    } catch {
      throw e;
    }
  }
}

function addChatMessage(text, role) {
  const el = document.createElement('div');
  el.className = `chat-msg ${role}`;
  el.textContent = text;
  $('#chat-messages').appendChild(el);
  $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
}

async function handleChatSend() {
  const input = $('#chat-input');
  const text = input.value.trim();
  if (!text) return;
  if (state.pendingProposal) {
    toast('Accept or reject current changes first', 'info');
    return;
  }

  input.value = '';
  addChatMessage(text, 'user');

  // Show spinner
  const spinnerMsg = document.createElement('div');
  spinnerMsg.className = 'chat-msg assistant';
  spinnerMsg.innerHTML = '<span class="spinner"></span> Generating changes...';
  $('#chat-messages').appendChild(spinnerMsg);
  $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;

  $('#chat-send').disabled = true;

  try {
    const result = await callGemini(text);
    spinnerMsg.remove();

    if (!result) {
      addChatMessage('No response from AI. Please check your API key.', 'error');
      return;
    }

    // Validate the result renders
    const testDiv = document.createElement('div');
    testDiv.style.position = 'absolute';
    testDiv.style.left = '-9999px';
    document.body.appendChild(testDiv);
    const testResult = await renderDiagram(result, testDiv, state.format);
    testDiv.remove();

    if (!testResult.ok) {
      addChatMessage(`AI returned invalid ${state.format} source. You can edit manually. Error: ${testResult.error}`, 'error');
      toast('AI returned invalid diagram', 'error');
      return;
    }

    addChatMessage('Changes proposed. Review the diff and accept/reject.', 'assistant');

    // Store proposal
    state.preProposalSource = state.workingSource;
    state.pendingProposal = { source: result };

    // Show diff
    showDiff(state.workingSource, result);
  } catch (e) {
    spinnerMsg.remove();
    addChatMessage(`Error: ${e.message}`, 'error');
    toast('AI request failed', 'error');
  } finally {
    $('#chat-send').disabled = false;
  }
}

// ── Diff actions ───────────────────────────────────────────────────
function acceptProposal() {
  if (!state.pendingProposal) return;
  state.workingSource = state.pendingProposal.source;
  state.pendingProposal = null;
  state.preProposalSource = null;
  hideDiff();
  applyWorkingSource(true);
  toast('Changes accepted', 'success');
}

function rejectProposal() {
  if (!state.pendingProposal) return;
  state.pendingProposal = null;
  state.preProposalSource = null;
  hideDiff();
  applyWorkingSource(false);
  toast('Changes rejected', 'info');
}

function editProposal() {
  if (!state.pendingProposal) return;
  // Put proposed source into editor and let user tweak it
  state.workingSource = state.pendingProposal.source;
  state.pendingProposal = null;
  state.preProposalSource = null;
  hideDiff();
  applyWorkingSource(true);
  // Open the editor
  $('#right-editor-area').classList.add('open');
  const arrow = $('#right-source-toggle .arrow');
  arrow.classList.add('open');
  toast('Edit the proposed changes, then they\'re yours', 'info');
}

// ── Zoom ───────────────────────────────────────────────────────────
function applyZoom() {
  $$('.zoom-wrapper').forEach(el => {
    el.style.transform = `scale(${state.zoom})`;
  });
}

function zoomIn() { state.zoom = Math.min(3, state.zoom + 0.15); applyZoom(); }
function zoomOut() { state.zoom = Math.max(0.25, state.zoom - 0.15); applyZoom(); }
function zoomReset() { state.zoom = 1; applyZoom(); }

// ── Theme ──────────────────────────────────────────────────────────
function toggleTheme() {
  document.documentElement.classList.toggle('light');
  const isDark = !document.documentElement.classList.contains('light');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');

  // Re-init mermaid theme
  mermaid.initialize({
    startOnLoad: false,
    theme: isDark ? 'dark' : 'default',
    securityLevel: 'loose',
    flowchart: { htmlLabels: true, curve: 'basis' },
  });

  // Re-render if loaded
  if (state.format) {
    renderDiagram(state.originalSource, $('#left-render'), state.format);
    renderDiagram(state.workingSource, $('#right-render'), state.format);
  }
}

// ── Export ──────────────────────────────────────────────────────────
function getFileExtension() {
  switch (state.format) {
    case 'mermaid': return '.mmd';
    case 'plantuml': return '.puml';
    case 'graphviz': return '.dot';
    default: return '.txt';
  }
}

function downloadText(text, filename) {
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadSvg() {
  const svgEl = $('#right-render svg') || $('#right-zoom-wrapper svg');
  if (!svgEl) { toast('No SVG to export', 'error'); return; }
  const svgText = new XMLSerializer().serializeToString(svgEl);
  downloadText(svgText, `diagram${getFileExtension().replace(/\.\w+$/, '.svg')}`);
  toast('SVG downloaded', 'success');
}

function downloadPng() {
  const svgEl = $('#right-render svg') || $('#right-zoom-wrapper svg');
  if (!svgEl) { toast('No SVG to export', 'error'); return; }
  const svgText = new XMLSerializer().serializeToString(svgEl);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);
  img.onload = () => {
    canvas.width = img.naturalWidth * 2;
    canvas.height = img.naturalHeight * 2;
    ctx.scale(2, 2);
    ctx.drawImage(img, 0, 0);
    canvas.toBlob((blob) => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `diagram.png`;
      a.click();
      URL.revokeObjectURL(a.href);
      URL.revokeObjectURL(url);
      toast('PNG downloaded', 'success');
    });
  };
  img.src = url;
}

function showExportModal() {
  if (!state.format) { toast('No diagram to export', 'error'); return; }
  $('#export-modal').classList.remove('hidden');
}

// ── Pane Divider Drag ──────────────────────────────────────────────
function initDivider() {
  const divider = $('#pane-divider');
  const leftPane = $('#left-pane');
  const rightPane = $('#right-pane');
  let isDragging = false;

  divider.addEventListener('mousedown', (e) => {
    isDragging = true;
    divider.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const container = $('#panes-container');
    const rect = container.getBoundingClientRect();
    const offset = e.clientX - rect.left;
    const total = rect.width - 5; // divider width
    const leftPct = Math.max(15, Math.min(85, (offset / total) * 100));
    leftPane.style.flex = `0 0 ${leftPct}%`;
    rightPane.style.flex = `0 0 ${100 - leftPct}%`;
  });

  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      divider.classList.remove('dragging');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
}

// ── Context Menu ───────────────────────────────────────────────────
function initContextMenu() {
  const menu = $('#context-menu');

  // Only show on right pane render area
  $('#right-render').addEventListener('contextmenu', (e) => {
    if (!state.format || state.format !== 'mermaid') return; // context menu for mermaid only
    e.preventDefault();
    menu.style.display = 'block';
    menu.style.left = `${e.clientX}px`;
    menu.style.top = `${e.clientY}px`;
  });

  document.addEventListener('click', () => {
    menu.style.display = 'none';
  });

  menu.querySelectorAll('.ctx-item').forEach(item => {
    item.addEventListener('click', () => {
      const action = item.dataset.action;
      handleContextAction(action);
      menu.style.display = 'none';
    });
  });
}

function handleContextAction(action) {
  if (!state.format) return;

  switch (action) {
    case 'add-node': {
      const id = `N${Date.now().toString(36)}`;
      const label = prompt('Node label:', 'New Node');
      if (!label) return;
      const line = state.format === 'mermaid' ? `    ${id}[${label}]` : '';
      if (line) {
        state.workingSource = state.workingSource.trimEnd() + '\n' + line;
        applyWorkingSource(true);
        toast('Node added', 'success');
      }
      break;
    }
    case 'add-edge': {
      const from = prompt('From node ID:');
      const to = prompt('To node ID:');
      const label = prompt('Edge label (optional):') || '';
      if (!from || !to) return;
      let line = '';
      if (state.format === 'mermaid') {
        line = label ? `    ${from} -->|${label}| ${to}` : `    ${from} --> ${to}`;
      }
      if (line) {
        state.workingSource = state.workingSource.trimEnd() + '\n' + line;
        applyWorkingSource(true);
        toast('Edge added', 'success');
      }
      break;
    }
    case 'group': {
      const nodes = prompt('Node IDs to group (comma-separated):');
      const name = prompt('Subgraph name:', 'Group');
      if (!nodes || !name) return;
      if (state.format === 'mermaid') {
        const subgraph = `    subgraph ${name}\n${nodes.split(',').map(n => `        ${n.trim()}`).join('\n')}\n    end`;
        state.workingSource = state.workingSource.trimEnd() + '\n' + subgraph;
        applyWorkingSource(true);
        toast('Subgraph created', 'success');
      }
      break;
    }
    case 'collapse': {
      const subName = prompt('Subgraph name to collapse:');
      if (!subName) return;
      collapseSubgraph(subName);
      break;
    }
    case 'expand': {
      const keys = Array.from(state.collapsedNodes.keys());
      if (keys.length === 0) { toast('No collapsed nodes', 'info'); return; }
      const nodeId = prompt(`Expand which node? Options: ${keys.join(', ')}`);
      if (!nodeId || !state.collapsedNodes.has(nodeId)) return;
      expandNode(nodeId);
      break;
    }
    case 'delete': {
      const nodeId = prompt('Node ID to delete:');
      if (!nodeId) return;
      deleteNode(nodeId);
      break;
    }
  }
}

// ── Abstraction operations ─────────────────────────────────────────
function collapseSubgraph(subName) {
  if (state.format !== 'mermaid') { toast('Collapse only supported for Mermaid', 'info'); return; }

  const regex = new RegExp(`(\\s*subgraph\\s+${escapeRegex(subName)}[\\s\\S]*?\\n\\s*end)`, 'm');
  const match = state.workingSource.match(regex);
  if (!match) { toast('Subgraph not found', 'error'); return; }

  const summaryId = `collapsed_${subName.replace(/\s+/g, '_')}`;
  state.collapsedNodes.set(summaryId, { original: match[1], label: subName });

  state.workingSource = state.workingSource.replace(match[1], `    ${summaryId}[${subName} ...]`);
  applyWorkingSource(true);
  toast(`Collapsed "${subName}"`, 'success');
}

function expandNode(nodeId) {
  const data = state.collapsedNodes.get(nodeId);
  if (!data) return;

  const regex = new RegExp(`\\s*${escapeRegex(nodeId)}\\[.*?\\]`);
  state.workingSource = state.workingSource.replace(regex, data.original);
  state.collapsedNodes.delete(nodeId);
  applyWorkingSource(true);
  toast(`Expanded "${data.label}"`, 'success');
}

function deleteNode(nodeId) {
  if (state.format !== 'mermaid') { toast('Delete only supported for Mermaid', 'info'); return; }
  const escaped = escapeRegex(nodeId);
  // Remove lines containing this node
  const lines = state.workingSource.split('\n');
  const filtered = lines.filter(line => {
    const trimmed = line.trim();
    // Remove standalone node definitions and edges that reference this node
    if (new RegExp(`^${escaped}(\\[|\\(|\\{|\\>|\\s*-->|\\s*---|\\s*$)`).test(trimmed)) return false;
    if (new RegExp(`-->\\s*${escaped}(\\s|$|\\[|\\(|\\{)`).test(trimmed)) return false;
    if (new RegExp(`---\\s*${escaped}(\\s|$)`).test(trimmed)) return false;
    return true;
  });
  state.workingSource = filtered.join('\n');
  applyWorkingSource(true);
  toast(`Deleted node "${nodeId}"`, 'success');
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ── Node click/double-click for property panel ─────────────────────
function initNodeInteraction() {
  $('#right-render').addEventListener('dblclick', (e) => {
    if (state.format !== 'mermaid') return;
    const node = e.target.closest('.node, .nodeLabel, [class*="node"]');
    if (!node) return;

    // Try to extract node ID from element
    const gParent = node.closest('g[id]');
    if (!gParent) return;

    const nodeId = gParent.id.replace(/^flowchart-/, '').replace(/-\d+$/, '');
    const labelEl = gParent.querySelector('.nodeLabel');
    const currentLabel = labelEl ? labelEl.textContent : nodeId;

    showPropertyPanel(nodeId, currentLabel);
  });
}

function showPropertyPanel(nodeId, currentLabel) {
  const panel = $('#property-panel');
  panel.style.display = 'block';
  $('#prop-label').value = currentLabel;
  $('#prop-style').value = '';
  $('#prop-shape').value = 'default';

  $('#prop-apply').onclick = () => {
    const newLabel = $('#prop-label').value;
    const shape = $('#prop-shape').value;
    const style = $('#prop-style').value;

    applyNodeChanges(nodeId, currentLabel, newLabel, shape, style);
    panel.style.display = 'none';
  };

  $('#prop-close').onclick = () => { panel.style.display = 'none'; };
}

function applyNodeChanges(nodeId, oldLabel, newLabel, shape, style) {
  if (state.format !== 'mermaid') return;

  let src = state.workingSource;

  // Replace label
  if (oldLabel !== newLabel) {
    // Pattern: nodeId[oldLabel] or nodeId(oldLabel) etc
    const labelPatterns = [
      new RegExp(`(${escapeRegex(nodeId)}\\[)${escapeRegex(oldLabel)}(\\])`, 'g'),
      new RegExp(`(${escapeRegex(nodeId)}\\()${escapeRegex(oldLabel)}(\\))`, 'g'),
      new RegExp(`(${escapeRegex(nodeId)}\\{)${escapeRegex(oldLabel)}(\\})`, 'g'),
      new RegExp(`(${escapeRegex(nodeId)}\\(\\[)${escapeRegex(oldLabel)}(\\]\\))`, 'g'),
      new RegExp(`(${escapeRegex(nodeId)}\\[\\[)${escapeRegex(oldLabel)}(\\]\\])`, 'g'),
    ];
    for (const pat of labelPatterns) {
      src = src.replace(pat, `$1${newLabel}$2`);
    }
  }

  // Change shape
  if (shape !== 'default') {
    const shapeMap = {
      round: ['(', ')'],
      stadium: ['([', '])'],
      diamond: ['{', '}'],
      hexagon: ['{{', '}}'],
      cylinder: ['[(', ')]'],
    };
    const [open, close] = shapeMap[shape] || ['[', ']'];
    // Replace existing shape brackets around the label
    const shapeRegex = new RegExp(`${escapeRegex(nodeId)}[\\[\\(\\{]+.*?[\\]\\)\\}]+`);
    src = src.replace(shapeRegex, `${nodeId}${open}${newLabel}${close}`);
  }

  // Add style
  if (style) {
    src = src.trimEnd() + `\n    style ${nodeId} ${style}`;
  }

  state.workingSource = src;
  applyWorkingSource(true);
  toast('Node updated', 'success');
}

// ── Example diagrams ───────────────────────────────────────────────
const EXAMPLES = {
  mermaid: `graph TD
    A[Start] --> B{Is it working?}
    B -->|Yes| C[Great!]
    B -->|No| D[Debug]
    D --> E[Check Logs]
    E --> F{Found Issue?}
    F -->|Yes| G[Fix It]
    F -->|No| H[Ask for Help]
    G --> I[Test Again]
    H --> I
    I --> B`,

  plantuml: `@startuml
actor User
participant "Web App" as WA
participant "API Server" as API
database "Database" as DB

User -> WA: Open Page
WA -> API: GET /data
API -> DB: SELECT * FROM items
DB --> API: Result set
API --> WA: JSON response
WA --> User: Display data

User -> WA: Submit Form
WA -> API: POST /data
API -> DB: INSERT INTO items
DB --> API: Success
API --> WA: 201 Created
WA --> User: Show confirmation
@enduml`,

  graphviz: `digraph G {
    rankdir=LR;
    node [shape=box, style="rounded,filled", fillcolor="#e8f0fe", fontname="Arial"];
    edge [fontname="Arial", fontsize=10];

    start [label="Start", shape=ellipse, fillcolor="#a8dab5"];
    input [label="User Input"];
    validate [label="Validate", shape=diamond, fillcolor="#fff3cd"];
    process [label="Process Data"];
    store [label="Store Results", shape=cylinder, fillcolor="#d4e6f1"];
    output [label="Display Output"];
    error [label="Show Error", fillcolor="#f8d7da"];
    end_ [label="End", shape=ellipse, fillcolor="#f5b7b1"];

    start -> input;
    input -> validate;
    validate -> process [label="valid"];
    validate -> error [label="invalid"];
    process -> store;
    store -> output;
    output -> end_;
    error -> input [label="retry"];
}`
};

// ── Event Bindings ─────────────────────────────────────────────────
function init() {
  // Theme from storage
  const saved = localStorage.getItem('theme');
  if (saved === 'light') document.documentElement.classList.add('light');

  initDivider();
  initContextMenu();
  initNodeInteraction();

  // Load button
  $('#load-btn').addEventListener('click', () => {
    const src = $('#input-source').value.trim();
    if (src) loadDiagram(src);
  });

  // File input
  $('#drop-zone').addEventListener('click', (e) => {
    if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON' && !e.target.classList.contains('example-chip')) {
      $('#file-input').click();
    }
  });

  $('#file-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        $('#input-source').value = ev.target.result;
        loadDiagram(ev.target.result.trim());
      };
      reader.readAsText(file);
    }
  });

  // Drag and drop
  const dropZone = $('#drop-zone');
  ['dragenter', 'dragover'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
  });
  dropZone.addEventListener('drop', (e) => {
    const file = e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        $('#input-source').value = ev.target.result;
        loadDiagram(ev.target.result.trim());
      };
      reader.readAsText(file);
    }
  });

  // Also support drag-drop on the whole body when in editor view
  document.body.addEventListener('dragover', (e) => e.preventDefault());
  document.body.addEventListener('drop', (e) => {
    e.preventDefault();
    if ($('#editor-view').classList.contains('hidden')) return;
    const file = e.dataTransfer.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => loadDiagram(ev.target.result.trim());
      reader.readAsText(file);
    }
  });

  // Example chips
  $$('.example-chip').forEach(chip => {
    chip.addEventListener('click', (e) => {
      e.stopPropagation();
      const example = EXAMPLES[chip.dataset.example];
      if (example) {
        $('#input-source').value = example;
      }
    });
  });

  // Toolbar buttons
  $('#btn-undo').addEventListener('click', undo);
  $('#btn-redo').addEventListener('click', redo);
  $('#btn-zoom-in').addEventListener('click', zoomIn);
  $('#btn-zoom-out').addEventListener('click', zoomOut);
  $('#btn-zoom-reset').addEventListener('click', zoomReset);
  $('#btn-theme').addEventListener('click', toggleTheme);
  $('#btn-export').addEventListener('click', showExportModal);

  // Chat toggle
  $('#btn-chat-toggle').addEventListener('click', () => {
    const panel = $('#chat-panel');
    panel.classList.toggle('open');
    $('#btn-chat-toggle').classList.toggle('active');
    if (panel.classList.contains('open')) {
      $('#chat-input').focus();
    }
  });

  // Source toggles
  $('#left-source-toggle').addEventListener('click', () => {
    $('#left-source-area').classList.toggle('open');
    $('#left-source-toggle .arrow').classList.toggle('open');
  });

  $('#right-source-toggle').addEventListener('click', () => {
    $('#right-editor-area').classList.toggle('open');
    $('#right-source-toggle .arrow').classList.toggle('open');
  });

  // Source editor changes (debounced)
  $('#source-editor').addEventListener('input', () => {
    clearTimeout(editorDebounceTimer);
    editorDebounceTimer = setTimeout(() => {
      const newSource = $('#source-editor').value;
      if (newSource !== state.workingSource) {
        state.workingSource = newSource;
        applyWorkingSource(true);
      }
    }, 500);
  });

  // Tab support in editor
  $('#source-editor').addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const ta = e.target;
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
      ta.selectionStart = ta.selectionEnd = start + 2;
    }
  });

  // Chat
  $('#chat-send').addEventListener('click', handleChatSend);
  $('#chat-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleChatSend();
    }
  });

  // Diff actions
  $('#btn-diff-accept').addEventListener('click', acceptProposal);
  $('#btn-diff-reject').addEventListener('click', rejectProposal);
  $('#btn-diff-edit').addEventListener('click', editProposal);

  // Export actions
  $('#export-clipboard').addEventListener('click', () => {
    navigator.clipboard.writeText(state.workingSource).then(() => {
      toast('Copied to clipboard', 'success');
      $('#export-modal').classList.add('hidden');
    });
  });
  $('#export-file').addEventListener('click', () => {
    downloadText(state.workingSource, `diagram${getFileExtension()}`);
    toast('File downloaded', 'success');
    $('#export-modal').classList.add('hidden');
  });
  $('#export-svg').addEventListener('click', () => {
    downloadSvg();
    $('#export-modal').classList.add('hidden');
  });
  $('#export-png').addEventListener('click', () => {
    downloadPng();
    $('#export-modal').classList.add('hidden');
  });
  $('#export-cancel').addEventListener('click', () => {
    $('#export-modal').classList.add('hidden');
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Ctrl+Z / Cmd+Z = Undo
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
      if (document.activeElement !== $('#source-editor') && document.activeElement !== $('#chat-input')) {
        e.preventDefault();
        undo();
      }
    }
    // Ctrl+Shift+Z / Cmd+Shift+Z = Redo
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
      if (document.activeElement !== $('#source-editor') && document.activeElement !== $('#chat-input')) {
        e.preventDefault();
        redo();
      }
    }
    // Escape to close modals/menus
    if (e.key === 'Escape') {
      $('#context-menu').style.display = 'none';
      $('#property-panel').style.display = 'none';
      if (!$('#export-modal').classList.contains('hidden')) $('#export-modal').classList.add('hidden');
      if (!$('#apikey-modal').classList.contains('hidden')) $('#apikey-modal').classList.add('hidden');
    }
  });

  // Close modals on overlay click
  $('#export-modal').addEventListener('click', (e) => {
    if (e.target === $('#export-modal')) $('#export-modal').classList.add('hidden');
  });
  $('#apikey-modal').addEventListener('click', (e) => {
    if (e.target === $('#apikey-modal')) $('#apikey-modal').classList.add('hidden');
  });
}

// Boot
init();
</script>
</body>
</html>
