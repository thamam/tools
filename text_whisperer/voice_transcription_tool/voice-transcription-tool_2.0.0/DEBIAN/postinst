#!/bin/bash

set -e

# Install Python dependencies
echo "Installing Python dependencies..."

# Create a virtual environment if it doesn't exist
VENV_DIR="/usr/share/voice-transcription-tool/.venv"
if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
fi

# Activate virtual environment and install dependencies
source "$VENV_DIR/bin/activate"

# Install required Python packages
pip install --upgrade pip
pip install openai-whisper>=20231117
pip install SpeechRecognition>=3.10.0
pip install PyAudio>=0.2.11
pip install keyboard>=0.13.5
pip install pystray>=0.19.4
pip install Pillow>=10.0.0
pip install pygame>=2.5.0

# Try to install openWakeWord (optional)
pip install openwakeword || echo "openWakeWord installation failed - wake word detection will use fallback"

# Set permissions for the application directory
chown -R root:root /usr/share/voice-transcription-tool
chmod -R 755 /usr/share/voice-transcription-tool

# Make the launcher script executable
chmod +x /usr/bin/voice-transcription-tool

# Update desktop database
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications
fi

# Create user configuration directory template
mkdir -p /etc/skel/.config/voice-transcription-tool

echo "Voice Transcription Tool installation completed successfully!"
echo ""
echo "To run the application:"
echo "  1. From terminal: voice-transcription-tool"
echo "  2. From applications menu: Search for 'Voice Transcription Tool'"
echo ""
echo "For global hotkeys (Alt+D, Alt+S, Alt+W), run with sudo:"
echo "  sudo voice-transcription-tool"
echo ""
echo "Note: First launch may take some time to download speech models."

#DEBHELPER#

exit 0